---
title: "R Notebook"
output: html_notebook
---

```{r}
# Parameters
M <- 1000
CFR <- 0.01

#severity, duration, qol parameters (mean, sd) (threshold)
params <- list(
  severity_params = list(mu = 15, sd = 5, medium_threshold = 5, high_threshold = 15),
  duration_params = list(low_mu = 2, low_sd = 1, medium_mu = 6, medium_sd = 2, high_mu = 12, high_sd = 3),
  qol_params = list(low_mu = 2, low_sd = 0.5, medium_mu = 4, medium_sd = 1, high_mu = 6, high_sd = 1.5)
)


# Defining function to simulate population level qol loss
simulate_mpox_impact <- function(M, CFR, severity_params, duration_params, qol_params) {
  # Simulating deaths
  deaths <- rbinom(1, M, CFR)
  survivors <- M - deaths

#function to convert mu and sd to k (shape) and theta (scale)
gamma_params <- function(mu, sd) {
  k <- (mu / sd) ^ 2
  theta <- (sd ^ 2) / mu
  return(list(k = k, theta = theta))
}
  
#function to convert all mu and sd in a parameter list to k and theta
convert_params <- function(param_list) {
  converted_params <- lapply(names(param_list), function(param) {
    if (grepl("_mu$", param) || param == "mu") {
      base_name <- sub("_mu$", "", param)
      base_name <- ifelse(base_name == "mu", "", base_name)
      gamma_param <- gamma_params(param_list[[param]], param_list[[paste0(base_name, ifelse(base_name == "", "sd", "_sd"))]])
      return(setNames(gamma_param, paste0(base_name, "_", names(gamma_param))))
    } else if (!grepl("_sd$", param) && param != "sd") {
      return(setNames(list(param_list[[param]]), param))
    }
  })
  return(do.call(c, converted_params))
}

#convert all parameter lists
params <- lapply(params, convert_params)


  # Simulate lesions and categorizing severity
  lesions <- rgamma(survivors, shape = params$severity_params$`_k`, scale = params$severity_params$`_theta`)
  severity <- cut(lesions, breaks = c(0, params$severity_params$medium_threshold, params$severity_params$high_threshold, Inf), labels = c("low", "medium", "high"))
  severity_counts <- table(severity)

    severity_probs <- prop.table(severity_counts)

  # Simulate duration for each severity category
  duration <- list(
    low = rgamma(sum(severity == "low"), shape = params$duration_params$low_k, scale = params$duration_params$low_theta),
    medium = rgamma(sum(severity == "medium"), shape = params$duration_params$medium_k, scale = params$duration_params$medium_theta),
    high = rgamma(sum(severity == "high"), shape = params$duration_params$high_k, scale = params$duration_params$high_theta)
  )

  # Simulate quality of life loss for each severity category
  qol_loss <- list(
    low = rbeta(sum(severity == "low"), shape1 = params$qol_params$low_k, shape2 = params$qol_params$low_theta),
    medium = rbeta(sum(severity == "medium"), shape1 = params$qol_params$medium_k, shape2 = params$qol_params$medium_theta),
    high = rbeta(sum(severity == "high"), shape1 = params$qol_params$high_k, shape2 = params$qol_params$high_theta)
  )

  # Calculate and return population-level quality of life loss
  total_qol_loss <- sum(qol_loss$low) + sum(qol_loss$medium) + sum(qol_loss$high)
  
return(list(
    total_qol_loss = total_qol_loss,
    severity_probs = severity_probs,
    lesions = lesions))
}


```




```{r}
# Parameters for vaccination simulation
vacc_coverage <- 0.7
ve_I <- 0.8
ve_S <- 0.7
ve_D <- 0.9

#changed severity params for vaccinated
mean 
sd

k<- mean/
scale =
  
simulate_mpox_vaccination <- function(vacc_coverage, ve_I, ve_S, ve_D, M, CFR, severity_params, duration_params, qol_params) {
  # Simulate deaths and survivors for unvaccinated and vaccinated groups
  unvaccinated_infected <- rbinom(1, M, 1 - vacc_coverage)
  vaccinated_infected <- rbinom(1, M, vacc_coverage * (1 - ve_I))
  total_infected <- unvaccinated_infected + vaccinated_infected

  # Adjust CFR for vaccinated group considering vaccination efficacy against death
  adjusted_CFR_unvaccinated <- CFR
  adjusted_CFR_vaccinated <- CFR * (1 - ve_D)

  # Simulate deaths and survivors
  deaths_unvaccinated <- rbinom(1, unvaccinated_infected, adjusted_CFR_unvaccinated)
  survivors_unvaccinated <- unvaccinated_infected - deaths_unvaccinated

  deaths_vaccinated <- rbinom(1, vaccinated_infected, adjusted_CFR_vaccinated)
  survivors_vaccinated <- vaccinated_infected - deaths_vaccinated

  # Calculate QoL loss for unvaccinated survivors
  unvaccinated_qol_loss <- simulate_mpox_impact(survivors_unvaccinated, CFR, severity_params, duration_params, qol_params) #change to unvaccinated infected

  # Calculate QoL loss for vaccinated survivors with adjusted severity
  vaccinated_qol_loss <- simulate_mpox_impact(survivors_vaccinated, CFR, severity_params, duration_params, qol_params) #change cfr # change to vaccinated infected
  adjusted_lesions <- vaccinated_qol_loss$lesions * (1 - ve_S)

  # Generate counts in different disease thresholds for vaccinated survivors
  vaccinated_severity <- cut(adjusted_lesions, breaks = c(0, severity_params$medium_threshold, severity_params$high_threshold, Inf), labels = c("low", "medium", "high"))
  vaccinated_severity_counts <- table(vaccinated_severity)
  vaccinated_severity_probs <- prop.table(vaccinated_severity_counts)

  # Simulate QoL loss for each severity category for vaccinated survivors
  vaccinated_qol_loss_adj <- list(
    low = rbeta(sum(vaccinated_severity == "low"), shape1 = qol_params$low_shape1, shape2 = qol_params$low_shape2),
    medium = rbeta(sum(vaccinated_severity == "medium"), shape1 = qol_params$medium_shape1, shape2 = qol_params$medium_shape2),
    high = rbeta(sum(vaccinated_severity == "high"), shape1 = qol_params$high_shape1, shape2 = qol_params$high_shape2)
  )

  total_vaccinated_qol_loss <- sum(vaccinated_qol_loss_adj$low) + sum(vaccinated_qol_loss_adj$medium) + sum(vaccinated_qol_loss_adj$high)
  
  # Combine QoL losses
  total_qol_loss <- unvaccinated_qol_loss$total_qol_loss + total_vaccinated_qol_loss
  
  return(total_qol_loss)
}



```
```{r}
# Wrapper function to run both simulations 1000 times each
run_simulations <- function(num_simulations, M, CFR, severity_params, duration_params, qol_params, vacc_coverage, ve_I, ve_S, ve_D) {
  impact_results <- numeric(num_simulations)
  vaccination_results <- numeric(num_simulations)
  
  for (i in 1:num_simulations) {
    impact_results[i] <- simulate_mpox_impact(M, CFR, severity_params, duration_params, qol_params)$total_qol_loss
    vaccination_results[i] <- simulate_mpox_vaccination(vacc_coverage, ve_I, ve_S, ve_D, M, CFR, severity_params, duration_params, qol_params)
  }
  
  return(list(
    impact_results = impact_results,
    vaccination_results = vaccination_results
  ))
}

# Run simulations
num_simulations <- 1000
simulation_results <- run_simulations(num_simulations, M, CFR, severity_params, duration_params, qol_params, vacc_coverage, ve_I, ve_S, ve_D)

# Print results
print(summary(simulation_results$impact_results))
print(summary(simulation_results$vaccination_results))

results_data_frame<- as.data.frame(simulation_results)
```
