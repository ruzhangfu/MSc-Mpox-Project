```{r}
# PARAMETERS
# Set the parameters for the simulation
counts <- 1000
cfr <- 0.01
mild_threshold <- 20
moderate_threshold <- 50
lambda <- 10

# Probabilities for infection status
prob_vaccinated_infected <- 0.1
prob_unvaccinated_infected <- 0.2
prob_not_infected <- 0.7

# Gamma distribution parameters for disease duration (interpreted in days)
shape <- 2
scale <- 5

# Beta distribution parameters for QoL loss
qol_loss_params <- list(
  "vaccinated and infected" = c(alpha = 2, beta = 8),
  "unvaccinated and infected" = c(alpha = 2, beta = 5),
  "not infected" = c(alpha = 1, beta = 10),
  "mild" = c(alpha = 2, beta = 8),
  "moderate" = c(alpha = 2, beta = 5),
  "severe" = c(alpha = 3, beta = 3)
)

# HELPER FUNCTIONS

# Simulate deaths (total M: 1000)
# Binomial distribution
simulate_deaths <- function(counts, cfr){
  return(rbinom(counts, size=1, prob=cfr))
}

# Simulate disease duration in days
# Gamma distribution
simulate_duration <- function(counts, shape, scale){
  return(rgamma(counts, shape = shape, scale = scale))
}

# Define the helper function to simulate lesions and categorize severity
categorize_severity <- function(survivors_count, lambda, mild_threshold, moderate_threshold){
  # Simulate the number of lesions for each survivor
  lesions <- rpois(survivors_count, lambda = lambda)
  
  # Categorize the severity based on the number of lesions
  severity <- cut(lesions, breaks = c(-Inf, mild_threshold, moderate_threshold, Inf),
                  labels = c("mild", "moderate", "severe"))
  
  return(list(lesions = lesions, severity = severity))
}

# Define the helper function to simulate infection status
simulate_infection_status <- function(counts, prob_vaccinated_infected, prob_unvaccinated_infected, prob_not_infected){
  # Ensure the probabilities sum to 1
  stopifnot(sum(prob_vaccinated_infected + prob_unvaccinated_infected + prob_not_infected) == 1)
  
  # Simulate infection status based on the given probabilities
  status_counts <- rmultinom(1, size = counts, prob = c(prob_vaccinated_infected, prob_unvaccinated_infected, prob_not_infected))
  status <- rep(c("vaccinated and infected", "unvaccinated and infected", "not infected"), times = status_counts)
  
  return(status)
}

# Define the function to calculate QoL loss using beta distribution
calculate_qol_loss <- function(infection_status, severity, duration, qol_loss_params){
  # Initialize QoL loss
  qol_loss <- numeric(length(infection_status))
  
  # Apply QoL loss based on infection status
  for (status in unique(infection_status)) {
    params <- qol_loss_params[[status]]
    qol_loss[infection_status == status] <- rbeta(sum(infection_status == status), params['alpha'], params['beta'])
  }
  
  # Apply additional QoL loss based on severity
  for (sev in unique(severity)) {
    params <- qol_loss_params[[sev]]
    qol_loss[severity == sev] <- qol_loss[severity == sev] + rbeta(sum(severity == sev), params['alpha'], params['beta'])
  }
  
  # Adjust QoL loss based on duration (if applicable)
  qol_loss[!is.na(duration)] <- qol_loss[!is.na(duration)] * duration[!is.na(duration)]
  
  return(qol_loss)
}

# Define the main simulation function
run_simulation <- function(){
  # Simulate deaths and store the result in a variable
  deaths_vector <- simulate_deaths(counts, cfr)
  deaths_count <- sum(deaths_vector)
  survivors_count <- counts - deaths_count

  # Simulate lesions and categorize severity using the helper function
  severity_data <- categorize_severity(survivors_count, lambda, mild_threshold, moderate_threshold)

  # Extract lesions and severity from the result
  lesions <- severity_data$lesions
  severity <- severity_data$severity

  # Simulate infection status for each individual
  infection_status <- simulate_infection_status(counts, prob_vaccinated_infected, prob_unvaccinated_infected, prob_not_infected)

  # Identify infected individuals
  infected_indices <- which(infection_status %in% c("vaccinated and infected", "unvaccinated and infected"))
  infected_count <- length(infected_indices)

  # Simulate infection duration in days for infected individuals
  infection_duration <- rep(NA, counts)
  if (infected_count > 0) {
    infection_duration[infected_indices] <- simulate_duration(infected_count, shape, scale)
  }

  # Calculate QoL loss for each individual using beta distribution
  qol_loss <- calculate_qol_loss(infection_status, severity, infection_duration, qol_loss_params)

  # Combine lesions, severity, infection status, infection duration, and QoL loss into a data frame for better handling
  full_data <- data.frame(
    status = c(rep("dead", deaths_count), rep("alive", survivors_count)),
    lesions = c(rep(NA, deaths_count), lesions),
    severity = c(rep(NA, deaths_count), severity),
    infection_status = infection_status,
    infection_duration = infection_duration,
    qol_loss = qol_loss
  )
  
  return(full_data)
}

# Define the wrapper function to run the simulation 1000 times
run_multiple_simulations <- function(n){
  results_list <- lapply(1:n, function(x) run_simulation())
  combined_results <- do.call(rbind, results_list)
  return(combined_results)
}

# Run the simulation 1000 times
all_results <- run_multiple_simulations(1000)

# Inspect the combined results
print(head(all_results))

```