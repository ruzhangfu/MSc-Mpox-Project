```{r}
library(dplyr)
# Parameters
M <- 1000  # number of cases. will use data for number of cases per year in the DRC. 
CFR <- 0.1  # Case Fatality Rate
vacc_coverage = 0.7 
ve_i = 0.8 
ve_s = 0.5 
ve_d = 0.9

# Severity, duration, and quality of life parameters (mean, sd, thresholds)
params <- list(
  severity_params = list(mu = 15, sd = 5, medium_threshold = 5, high_threshold = 15),
  duration_params = list(low_mu = 2, low_sd = 1, medium_mu = 6, medium_sd = 2, high_mu = 12, high_sd = 3),
  qol_params = list(low_mu = 2, low_sd = 0.5, medium_mu = 4, medium_sd = 1, high_mu = 6, high_sd = 1.5)
)

#Revised gamma_mv function
gamma_mv <- function(n, mu, sd) {
  if (is.na(n) || n <= 0) {
    return(rep(0, n))  # Return zero vector if n is not positive
  }

  #Ensure mean (mu) is positive and non-zero
  if (mu <= 0) {
    mu <- 1e-10  # Very small number to avoid errors
  }
  
  #Ensure standard deviation (sd) is positive and non-zero
  if (sd <= 0) {
    sd <- 1e-10  # Very small number to avoid errors
  }
  
  scale <- sd ^ 2 / mu
  shape <- mu / scale
  
  #Ensure shape and scale are positive and non-zero
  if (shape <= 0) {
    shape <- 1e-10  # Very small number to avoid errors
  }
  if (scale <= 0) {
    scale <- 1e-10  # Very small number to avoid errors
  }
  
  return(rgamma(n, shape, scale))
}

# Revised calculate_qol_loss function
calculate_qol_loss <- function(infections, severity_params, duration_params, qol_params) {
  #generate lesion number
  lesions <- gamma_mv(infections, severity_params$mu, severity_params$sd)
  severity <- cut(lesions, breaks = c(0, severity_params$medium_threshold, severity_params$high_threshold, Inf), labels = c("low", "medium", "high"), include.lowest = TRUE)
  #sum severity counts
  severity_counts <- list(
    low = sum(severity == "low", na.rm = TRUE),
    medium = sum(severity == "medium", na.rm = TRUE),
    high = sum(severity == "high", na.rm = TRUE)
  )
  #simulate duration (gamma)
  duration <- list(
    low = if (severity_counts$low > 0) gamma_mv(severity_counts$low, duration_params$low_mu, duration_params$low_sd) else numeric(0),
    medium = if (severity_counts$medium > 0) gamma_mv(severity_counts$medium, duration_params$medium_mu, duration_params$medium_sd) else numeric(0),
    high = if (severity_counts$high > 0) gamma_mv(severity_counts$high, duration_params$high_mu, duration_params$high_sd) else numeric(0)
  )
  #simulate qol loss (beta)
  qol_loss <- list(
    low = if (severity_counts$low > 0) rbeta(severity_counts$low, shape1 = qol_params$low_mu, shape2 = qol_params$low_sd) else numeric(0),
    medium = if (severity_counts$medium > 0) rbeta(severity_counts$medium, shape1 = qol_params$medium_mu, shape2 = qol_params$medium_sd) else numeric(0),
    high = if (severity_counts$high > 0) rbeta(severity_counts$high, shape1 = qol_params$high_mu, shape2 = qol_params$high_sd) else numeric(0)
  )
  #calculate qol loss
  total_qol_loss <- sum(qol_loss$low * duration$low) + sum(qol_loss$medium * duration$medium) + sum(qol_loss$high * duration$high)
  
  list(total_qol_loss = total_qol_loss, severity_counts = severity_counts)
}

# simulate_mpox_impact function
simulate_mpox_impact <- function(M, CFR, params, vacc_coverage, ve_i, ve_s, ve_d) {
  
  #qol no vaccination
  infections_no_vacc <- M
  deaths_no_vacc <- rbinom(1, infections_no_vacc, CFR)
  survivors_no_vacc <- infections_no_vacc - deaths_no_vacc
  result_no_vacc <- calculate_qol_loss(infections_no_vacc, params$severity_params, params$duration_params, params$qol_params)
  
  #qol with vaccination
  unvaccinated_pop <- rbinom(1, M, 1 - vacc_coverage)
  vaccinated_pop <- M - unvaccinated_pop
  unvaccinated_infections <- unvaccinated_pop
  vaccinated_infections <- rbinom(1, vaccinated_pop, 1 - ve_i)
  infections_with_vacc <- unvaccinated_infections + vaccinated_infections
  
  deaths_unvacc <- rbinom(1, unvaccinated_infections, CFR)
  deaths_vacc <- rbinom(1, vaccinated_infections, CFR * (1 - ve_d))
  total_deaths_with_vacc <- deaths_unvacc + deaths_vacc
  survivors_with_vacc <- infections_with_vacc - total_deaths_with_vacc
  
  #adjust severity parameters for vaccinated individuals (ve_s)
  adjusted_severity_params <- params$severity_params
  adjusted_severity_params$mu <- adjusted_severity_params$mu * (1 - ve_s)
  
  #ensure adjusted severity mean (mu) is positive and non-zero
  if (adjusted_severity_params$mu <= 0) {
    adjusted_severity_params$mu <- 1e-10  # Very small number to avoid errors
    message("Adjusted severity mean (mu) to avoid non-positive value")
  }
  
  #calculate qol loss for vaccinated results
  result_with_vacc <- calculate_qol_loss(infections_with_vacc, adjusted_severity_params, params$duration_params, params$qol_params)
  
  list(
    cases_with_vaccination = infections_with_vacc,
    cases_without_vaccination = infections_no_vacc,
    without_vaccination_qol_loss = result_no_vacc$total_qol_loss,
    with_vaccination_qol_loss = result_with_vacc$total_qol_loss,
    deaths_without_vaccination = deaths_no_vacc,
    survivors_without_vaccination = survivors_no_vacc,
    deaths_with_vaccination = total_deaths_with_vacc,
    survivors_with_vaccination = survivors_with_vacc,
    severity_counts_without_vaccination = result_no_vacc$severity_counts,
    severity_counts_with_vaccination = result_with_vacc$severity_counts
  )
}

# Define a function to run 10 iterations and sum the results
simulate_10_iterations <- function() {
  #use Lapply when fixed annual rate is included M * (1+i)^n
  results <- replicate(10, simulate_mpox_impact(M, CFR, params, vacc_coverage, ve_i, ve_s, ve_d), simplify = FALSE)
  
  # Extract severity counts separately
  severity_counts_without_vaccination <- lapply(results, `[[`, "severity_counts_without_vaccination")
  severity_counts_with_vaccination <- lapply(results, `[[`, "severity_counts_with_vaccination")
  
  results_df <- bind_rows(lapply(results, function(x) x[!names(x) %in% c("severity_counts_without_vaccination", "severity_counts_with_vaccination")]),.id = "year") %>% 
    mutate(year = as.numeric(year),
           life_years_lost_death_with_vaccination = deaths_with_vaccination * (10 - (year-0.5)),
        life_years_lost_death_without_vaccination = deaths_without_vaccination * (10 - (year - 0.5)),
        number_vaccinated = M * vacc_coverage #NOT M IF FIXED INCREASE RATE IS INCLUDED
          ) 
  
  

  #summarizing results
  summarized_results <- results_df %>%
    summarize(
      cases_with_vaccination = sum(cases_with_vaccination),
      cases_without_vaccination = sum(cases_without_vaccination),
      without_vaccination_qol_loss = sum(without_vaccination_qol_loss),
      with_vaccination_qol_loss = sum(with_vaccination_qol_loss),
      deaths_without_vaccination = sum(deaths_without_vaccination),
      survivors_without_vaccination = sum(survivors_without_vaccination),
      deaths_with_vaccination = sum(deaths_with_vaccination),
      survivors_with_vaccination = sum(survivors_with_vaccination),
      life_years_lost_death_with_vaccination = sum(life_years_lost_death_with_vaccination),
      life_years_lost_death_without_vaccination = sum(life_years_lost_death_without_vaccination),
      number_vaccinated = sum(number_vaccinated)
    )
  
  #Summarize severity counts separately
  summarized_severity_counts <- list(
    severity_counts_without_vaccination_low = sum(sapply(severity_counts_without_vaccination, `[[`, "low")),
    severity_counts_without_vaccination_medium = sum(sapply(severity_counts_without_vaccination, `[[`, "medium")),
    severity_counts_without_vaccination_high = sum(sapply(severity_counts_without_vaccination, `[[`, "high")),
    severity_counts_with_vaccination_low = sum(sapply(severity_counts_with_vaccination, `[[`, "low")),
    severity_counts_with_vaccination_medium = sum(sapply(severity_counts_with_vaccination, `[[`, "medium")),
    severity_counts_with_vaccination_high = sum(sapply(severity_counts_with_vaccination, `[[`, "high"))
  )
  
  return(c(summarized_results, summarized_severity_counts))
}

# Run the entire process 1000 times

#one dose 
#can record quality of life loss per dose
ve_i = 0.75
results_replication_1000_times_one_dose <- replicate(1000, simulate_10_iterations(), simplify = FALSE) %>%
  bind_rows() %>%
  mutate(doses_number = number_vaccinated)

#two dose
ve_i = 0.85
results_replication_1000_times_two_dose <- replicate(1000, simulate_10_iterations(), simplify = FALSE) %>%
  bind_rows() %>%
  mutate(doses_number = number_vaccinated * 2)


```


```{r}
#Edge Test Cases
edge_test_cases <- list(
  list(M = 0, CFR = 0.01, vacc_coverage = 0.7, ve_i = 0.8, ve_s = 1, ve_d = 0.9, description = "ve_s set to 1"),
  list(M = 1000, CFR = 1, vacc_coverage = 0.7, ve_i = 0.8, ve_s = 0.5, ve_d = 0.9, description = "High Case Fatality Rate"),
  list(M = 1000, CFR = 0.01, vacc_coverage = 0, ve_i = 0.8, ve_s = 0.5, ve_d = 0.9, description = "No Vaccination Coverage"),
  list(M = 1000, CFR = 0.01, vacc_coverage = 1, ve_i = 0.8, ve_s = 0.5, ve_d = 0.9, description = "Full Vaccination Coverage"),
  list(M = 1000, CFR = 0.01, vacc_coverage = 0.7, ve_i = 0, ve_s = 0.5, ve_d = 0.9, description = "Zero Vaccine Efficacy for Infection"),
  list(M = 1000, CFR = 0.01, vacc_coverage = 0.7, ve_i = 1, ve_s = 0.5, ve_d = 0.9, description = "Full Vaccine Efficacy for Infection"),
  list(M = 1000, CFR = 0.01, vacc_coverage = 0.7, ve_i = 0.8, ve_s = 0, ve_d = 0.9, description = "Zero Vaccine Efficacy for Severity"),
  list(M = 1000, CFR = 0.01, vacc_coverage = 0.7, ve_i = 0.8, ve_s = 1, ve_d = 0.9, description = "Full Vaccine Efficacy for Severity"),
  list(M = 1000, CFR = 0.01, vacc_coverage = 0.7, ve_i = 0.8, ve_s = 0.5, ve_d = 0, description = "Zero Vaccine Efficacy for Death"),
  list(M = 1000, CFR = 0.01, vacc_coverage = 0.7, ve_i = 0.8, ve_s = 0.5, ve_d = 1, description = "Full Vaccine Efficacy for Death")
)

#Running edge tests
edge_test_results <- lapply(edge_test_cases, function(test_case) {
  message("Running test case: ", test_case$description)
  result <- simulate_mpox_impact(test_case$M, test_case$CFR, params, test_case$vacc_coverage, test_case$ve_i, test_case$ve_s, test_case$ve_d)
  return(c(test_case, result))
})

#Convert edge test results to dataframe
edge_test_results_df <- bind_rows(lapply(edge_test_results, as.data.frame))
edge_test_results_df

#Inspecting results
print(edge_test_results_df)

```